{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <script type="text/javascript" src="{{ url_for('static', filename='javascript/probability.js') }}"></script>
    <style>
        .video-container {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .video-container video {
            /* Make video to at least 100% wide and tall */
            min-width: 100%;
            min-height: 100%;

            /* Setting width & height to auto prevents the browser from stretching or squishing the video */
            width: auto;
            height: auto;

            /* Center the video */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #photon {
            width: 50%;
            height: 10%;
            position: fixed;
            left: 25%;
            background-color: red;
            z-index: 10000;
            font-size: 40px;
        }

        #info {
            width: 50px;
            height: 50px;
            position: fixed;
            left: 90%;
            background-color: blue;
            z-index: 10000;

        }
    </style>
{% endblock %}

{% block body %}
    <br>

    <div id="photon"></div>
    <div id="info" onclick="localStorage.clear();"></div>
    <div class="video-container">
        <video id="preview" style=""></video>
    </div>

    <script type="text/javascript">

        Instascan.Camera.getCameras().then(function (cameras) {
            if (cameras.length > 0) {
                if (cameras.length > 1) {
                    scanner.start(cameras[1]);
                } else {
                    scanner.start(cameras[0]);
                }
            } else {
                console.error('No cameras found.');
            }
        });
        // joined game yet
        var joined = false;
        var gameId = -1;

        // -1 no photon
        // 0 unmeasured
        // 1 spin 1
        // 2 spin 2 ...
        var state = -1;

        // Sending current photon to hub
        var sending = false;

        function sendPhoton() {
            if (sending) {
                return;
            }
            sending = true;
            var params = {
                'game': gameId,
                'photon': state
            };
            $.get("/add_photon", params, function (data) {
                if (data === true) {
                    state = -1
                } else {
                    console.log("not in hub")
                }
                sending = false;
            }).fail(function (data) {
                console.log("error");
                console.log(data);
                sending = false;
            })
        }

        var scanner = new Instascan.Scanner({
            video: document.getElementById('preview'),
            mirror: false,
            backgroundScan: false
        });

        scanner.addListener('scan', function (content) {
            alert(content);
            if (!joined) { // Join game
                joined = true;
                gameId = content;
                //assign photon spin (unknown to player)
                localStorage.setItem("spinKnown", "false");
                var spin = chooseSpin();
                console.log("Chose spin: " + spin);
                localStorage.setItem("spin", spin);
                state = 0; // Pick up photon
                $("#photon").html(state)

            } else { // Measure station or hub
                if (content === gameId) { // Hub
                    if (state !== 0) { // Already have photon
                        sendPhoton()
                    } else {
                        state = 0;
                    }
                } else {
                    //pass in previous spin and measurement direction
                    state = measureSpin(localStorage.getItem("spin"), content);
                    console.log("Measured state: " + state);
                    localStorage.setItem("spin", state);
                    localStorage.setItem("spinKnown", "true");
                    $("#photon").html(state)
                }
            }
        });
        Instascan.Camera.getCameras().then(function (cameras) {
            if (cameras.length > 0) {
                if (cameras.length > 1) {
                    scanner.start(cameras[1]);
                } else {
                    scanner.start(cameras[0]);
                }
            } else {
                console.error('No cameras found.');
            }
        }).catch(function (e) {
            console.error(e);
        });
    </script>

{% endblock %}
